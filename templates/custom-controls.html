{% macro positioning_area(config) %}

    <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        /* Center the stage */
        body {
            margin: 0;
            min-height: 100svh;
            display: grid;
            place-items: center;
            background: #f6f7f8;
            font-family: system-ui, sans-serif;
        }

        /* Light gray square */
        .stage {
            width: 800px;
            height: 800px;
            background: #e9ecef;
            border: 2px dashed #c7ccd1;
            border-radius: 16px;
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,.05);
            overflow: hidden;
            touch-action: none;
        }

        /* Draggable icon */
        .icon {
            width: 60px;
            height: 60px;
            background-image: url("{{ config.forager_url }}");
            background-size: cover;
            position: absolute;
            display: grid;
            place-items: center;
            border-radius: 12px;
            box-shadow: 0 6px 14px rgba(0,0,0,.15);
            cursor: grab;
            user-select: none;
            -webkit-user-drag: none;
            touch-action: none;
            transition: transform .12s ease;
        }
        .icon:active { cursor: grabbing; transform: scale(0.98); }

    </style>
    </head>

    <div class="stage" id="stage">
        <canvas id="mapImg" width="800" height="800"></canvas>

          {# Create NUM_FORAGERS icons #}
          {% for i in range(config.num_foragers) %}
            <div id="forager{{ i }}-container"
                 class="icon"
                 style="
                   left: {{ 20 + 80 * (i % 8) }}px;
                   top:  {{ 20 + 80 * (i // 8) }}px;
                   background-image: url('{{ config.forager_url }}');
                 ">
            </div>
          {% endfor %}
    </div>

    <script>
        /////////////////////////////////////////////////////
        // Draw the map from pixel data
        /////////////////////////////////////////////////////
        const data = {{ config.map }};  // H x W x 3
        const H = data.length;
        const W = data[0].length;
        const canvas = document.getElementById("mapImg");
        const ctx = canvas.getContext("2d");
        const imgData = ctx.createImageData(W, H);
        const buf = imgData.data;

        let idx = 0;
        for (let y = 0; y < H; y++) {
          for (let x = 0; x < W; x++) {
            const [r, g, b, a] = data[y][x];
            buf[idx++] = r;
            buf[idx++] = g;
            buf[idx++] = b;
            buf[idx++] = 255; // alpha
          }
        }
        ctx.putImageData(imgData, 0, 0);

        // Scale the 3×3 image up to fill the canvas (300×300)
        ctx.imageSmoothingEnabled = false;
        ctx.drawImage(canvas, 0, 0, W, H, 0, 0, canvas.width, canvas.height);

        /////////////////////////////////////////////////////
        // Functions to drag and drop foragers' icons
        /////////////////////////////////////////////////////
        const stage = document.getElementById('stage');
        const icons = Array.from(stage.querySelectorAll('.icon'));

        let active = null;
        let startPointer = { x: 0, y: 0 };
        let startOffset  = { x: 0, y: 0 };

        function getPos(el) {
            return {
                x: parseFloat(el.style.left || '0'),
                y: parseFloat(el.style.top  || '0')
            };
        }

        function clampToStage(el, x, y) {
            const rect = stage.getBoundingClientRect();
            const er = el.getBoundingClientRect();
            return {
                x: Math.min(Math.max(x, 0), rect.width - er.width),
                y: Math.min(Math.max(y, 0), rect.height - er.height)
            };
        }

        function onPointerDown(e) {
            const target = e.target.closest('.icon');
            if (!target) return;
            active = target;
            active.setPointerCapture(e.pointerId);
            const pos = getPos(active);
            startOffset = { x: pos.x, y: pos.y };
            startPointer = { x: e.clientX, y: e.clientY };
            active.style.transition = 'none';
        }

        function onPointerMove(e) {
            if (!active) return;
            const dx = e.clientX - startPointer.x;
            const dy = e.clientY - startPointer.y;
            const next = clampToStage(active, startOffset.x + dx, startOffset.y + dy);
            active.style.left = next.x + 'px';
            active.style.top  = next.y + 'px';
        }

        function onPointerUp(e) {
            if (!active) return;
            try { active.releasePointerCapture(e.pointerId); } catch {}
            active.style.transition = '';
            active = null;
        }

        stage.addEventListener('pointerdown', onPointerDown);
        window.addEventListener('pointermove', onPointerMove);
        window.addEventListener('pointerup', onPointerUp);


        /////////////////////////////////////////////////////
        // Function to stage the response for PsyNet
        /////////////////////////////////////////////////////
        psynet.stageResponse = function() {

              const icons = Array.from(document.querySelectorAll('.icon'));
              const positions = {};
              icons.forEach((el, idx) => {
                const x = parseFloat(el.style.left) || 0;
                const y = parseFloat(el.style.top)  || 0;
                positions[idx] = [x, y];
              });
              psynet.response.staged.rawAnswer = positions;

            {#const forager1 = document.getElementById('forager1-container');#}
            {#const x1 = parseFloat(forager1.style.left);#}
            {#const y1 = parseFloat(forager1.style.top);#}
            {##}
            {#const forager2 = document.getElementById('forager2-container');#}
            {#const x2 = parseFloat(forager2.style.left);#}
            {#const y2 = parseFloat(forager2.style.top);#}
            {##}
            {#psynet.response.staged.rawAnswer = {#}
            {#    0: [x1, y1], #}
            {#    1: [x2, y2]#}
        }

    </script>

{% endmacro %}